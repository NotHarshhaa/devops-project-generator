# Makefile for {{ project_name }}
# Generated by DevOps Project Generator

.PHONY: help install test lint format clean build deploy start stop logs health

# Default target
.DEFAULT_GOAL := help

# Variables
PROJECT_NAME := {{ project_name }}
ENVIRONMENT := {{ env | default('production') }}
PYTHON := python3
VENV := venv
ACTIVATE := $(VENV)/bin/activate

# Colors
BLUE := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

help: ## Show this help message
	@echo "$(BLUE){{ project_name }} - DevOps Project$(RESET)"
	@echo "$(GREEN)Available commands:$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(YELLOW)%-20s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Development Setup
install: ## Install dependencies and setup environment
	@echo "$(GREEN)Setting up development environment...$(RESET)"
	@if [ ! -d "$(VENV)" ]; then \
		$(PYTHON) -m venv $(VENV); \
		echo "$(BLUE)Virtual environment created$(RESET)"; \
	fi
	@. $(ACTIVATE); pip install --upgrade pip
	@. $(ACTIVATE); pip install -r app/sample-app/requirements.txt
	@echo "$(GREEN)Dependencies installed$(RESET)"

install-dev: ## Install development dependencies
	@echo "$(GREEN)Installing development dependencies...$(RESET)"
	@. $(ACTIVATE); pip install black flake8 mypy pytest pytest-cov pre-commit
	@. $(ACTIVATE); pre-commit install
	@echo "$(GREEN)Development dependencies installed$(RESET)"

# Code Quality
lint: ## Run linting
	@echo "$(GREEN)Running linting...$(RESET)"
	@. $(ACTIVATE); flake8 app/sample-app/ --count --select=E9,F63,F7,F82 --show-source --statistics
	@. $(ACTIVATE); flake8 app/sample-app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
	@. $(ACTIVATE); mypy app/sample-app/ --ignore-missing-imports

format: ## Format code with black
	@echo "$(GREEN)Formatting code...$(RESET)"
	@. $(ACTIVATE); black app/sample-app/ scripts/
	@echo "$(GREEN)Code formatted$(RESET)"

# Testing
test: ## Run tests
	@echo "$(GREEN)Running tests...$(RESET)"
	@. $(ACTIVATE); pytest app/sample-app/ --cov=app/sample-app --cov-report=term-missing --cov-report=html

test-watch: ## Run tests in watch mode
	@echo "$(GREEN)Running tests in watch mode...$(RESET)"
	@. $(ACTIVATE); pytest app/sample-app/ --cov=app/sample-app -f

# Security
security-scan: ## Run security scans
	@echo "$(GREEN)Running security scans...$(RESET)"
	@. $(ACTIVATE); safety check
	@. $(ACTIVATE); bandit -r app/sample-app/

{% if has_docker %}
# Docker commands
build: ## Build Docker image
	@echo "$(GREEN)Building Docker image...$(RESET)"
	@docker build -t $(PROJECT_NAME):latest ./containers/
	@docker tag $(PROJECT_NAME):latest $(PROJECT_NAME):$(ENVIRONMENT)

push: ## Push Docker image to registry
	@echo "$(GREEN)Pushing Docker image...$(RESET)"
	@docker push $(PROJECT_NAME):latest
	@docker push $(PROJECT_NAME):$(ENVIRONMENT)

docker-run: ## Run application with Docker
	@echo "$(GREEN)Running application with Docker...$(RESET)"
	@docker-compose -f containers/docker-compose.yml up -d

docker-stop: ## Stop Docker containers
	@echo "$(GREEN)Stopping Docker containers...$(RESET)"
	@docker-compose -f containers/docker-compose.yml down

docker-logs: ## Show Docker logs
	@docker-compose -f containers/docker-compose.yml logs -f
{% endif %}

{% if has_kubernetes %}
# Kubernetes commands
k8s-deploy: ## Deploy to Kubernetes
	@echo "$(GREEN)Deploying to Kubernetes...$(RESET)"
	@kubectl create namespace $(PROJECT_NAME)-$(ENVIRONMENT) --dry-run=client -o yaml | kubectl apply -f -
	@kubectl apply -f k8s/base/ --namespace $(PROJECT_NAME)-$(ENVIRONMENT)
	@if [ -d "k8s/overlays/$(ENVIRONMENT)" ]; then \
		kubectl apply -k k8s/overlays/$(ENVIRONMENT)/ --namespace $(PROJECT_NAME)-$(ENVIRONMENT); \
	else \
		kubectl apply -k k8s/overlays/production/ --namespace $(PROJECT_NAME)-$(ENVIRONMENT); \
	fi

k8s-status: ## Show Kubernetes status
	@echo "$(GREEN)Kubernetes deployment status:$(RESET)"
	@kubectl get pods --namespace $(PROJECT_NAME)-$(ENVIRONMENT)
	@kubectl get services --namespace $(PROJECT_NAME)-$(ENVIRONMENT)

k8s-logs: ## Show Kubernetes logs
	@kubectl logs -f deployment/$(PROJECT_NAME) --namespace $(PROJECT_NAME)-$(ENVIRONMENT)

k8s-delete: ## Delete Kubernetes deployment
	@echo "$(RED)Deleting Kubernetes deployment...$(RESET)"
	@kubectl delete namespace $(PROJECT_NAME)-$(ENVIRONMENT) --ignore-not-found=true
{% endif %}

{% if has_infra and infra == 'terraform' %}
# Terraform commands
tf-init: ## Initialize Terraform
	@echo "$(GREEN)Initializing Terraform...$(RESET)"
	@cd infra/terraform && terraform init

tf-plan: ## Show Terraform plan
	@echo "$(GREEN)Showing Terraform plan...$(RESET)"
	@cd infra/terraform && terraform plan

tf-apply: ## Apply Terraform changes
	@echo "$(GREEN)Applying Terraform changes...$(RESET)"
	@cd infra/terraform && terraform apply -auto-approve

tf-destroy: ## Destroy Terraform infrastructure
	@echo "$(RED)Destroying Terraform infrastructure...$(RESET)"
	@cd infra/terraform && terraform destroy -auto-approve
{% endif %}

# Application Management
start: ## Start the application
	@echo "$(GREEN)Starting application...$(RESET)"
	{% if has_docker %}
	@docker-compose -f containers/docker-compose.yml up -d
	{% else %}
	@. $(ACTIVATE); python app/sample-app/main.py
	{% endif %}

stop: ## Stop the application
	@echo "$(GREEN)Stopping application...$(RESET)"
	{% if has_docker %}
	@docker-compose -f containers/docker-compose.yml down
	{% else %}
	@pkill -f "main.py" || true
	{% endif %}

restart: stop start ## Restart the application

logs: ## Show application logs
	{% if has_docker %}
	@docker-compose -f containers/docker-compose.yml logs -f
	{% else %}
	@tail -f logs/app.log
	{% endif %}

# Health checks
health: ## Check application health
	@echo "$(GREEN)Checking application health...$(RESET)"
	{% if has_health_checks %}
	@curl -f http://localhost:8000/health || (echo "$(RED)Health check failed$(RESET)" && exit 1)
	@echo "$(GREEN)Application is healthy$(RESET)"
	{% else %}
	@echo "$(YELLOW)Health checks not enabled$(RESET)"
	{% endif %}

ready: ## Check application readiness
	@echo "$(GREEN)Checking application readiness...$(RESET)"
	{% if has_health_checks %}
	@curl -f http://localhost:8000/ready || (echo "$(RED)Readiness check failed$(RESET)" && exit 1)
	@echo "$(GREEN)Application is ready$(RESET)"
	{% else %}
	@echo "$(YELLOW)Readiness checks not enabled$(RESET)"
	{% endif %}

# Deployment
deploy: ## Deploy application
	@echo "$(GREEN)Deploying application...$(RESET)"
	@chmod +x scripts/deploy.sh
	@./scripts/deploy.sh deploy

rollback: ## Rollback deployment
	@echo "$(RED)Rolling back deployment...$(RESET)"
	@chmod +x scripts/deploy.sh
	@./scripts/deploy.sh rollback

# Setup
setup: ## Setup project environment
	@echo "$(GREEN)Setting up project...$(RESET)"
	@chmod +x scripts/setup.sh
	@./scripts/setup.sh

# Cleanup
clean: ## Clean up temporary files
	@echo "$(GREEN)Cleaning up...$(RESET)"
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete
	@find . -type f -name "*.pyo" -delete
	@find . -type f -name ".coverage" -delete
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)Cleanup completed$(RESET)"

clean-all: clean ## Clean everything including Docker
	@echo "$(RED)Cleaning everything...$(RESET)"
	{% if has_docker %}
	@docker system prune -f
	@docker volume prune -f
	{% endif %}
	@rm -rf $(VENV)
	@echo "$(GREEN)Full cleanup completed$(RESET)"

# Monitoring
{% if has_metrics %}
metrics: ## Show application metrics
	@echo "$(GREEN)Application metrics:$(RESET)"
	@curl -s http://localhost:9090/metrics | head -20

prometheus: ## Start Prometheus (if configured)
	@echo "$(GREEN)Starting Prometheus...$(RESET)"
	@if [ -f "monitoring/metrics/prometheus.yml" ]; then \
		prometheus --config.file=monitoring/metrics/prometheus.yml; \
	else \
		echo "$(YELLOW)Prometheus configuration not found$(RESET)"; \
	fi
{% endif %}

# Development helpers
dev-setup: install install-dev ## Setup full development environment
	@echo "$(GREEN)Development environment setup complete$(RESET)"

dev-run: ## Run in development mode
	@echo "$(GREEN)Running in development mode...$(RESET)"
	@ENV=development DEBUG=true . $(ACTIVATE); python app/sample-app/main.py

prod-run: ## Run in production mode
	@echo "$(GREEN)Running in production mode...$(RESET)"
	@ENV=production DEBUG=false . $(ACTIVATE); python app/sample-app/main.py

# Version and info
version: ## Show version information
	@echo "$(BLUE){{ project_name }}$(RESET)"
	@echo "Environment: $(ENVIRONMENT)"
	@echo "Python: $(shell $(PYTHON) --version)"
	@if [ -d ".git" ]; then echo "Git: $(shell git describe --tags --always 2>/dev/null || echo 'unknown')"; fi

info: ## Show project information
	@echo "$(BLUE)Project Information:$(RESET)"
	@echo "Name: $(PROJECT_NAME)"
	@echo "Environment: $(ENVIRONMENT)"
	@echo "CI/CD: {{ ci }}"
	@echo "Infrastructure: {{ infra }}"
	@echo "Deployment: {{ deploy }}"
	@echo "Observability: {{ observability }}"
	@echo "Security: {{ security }}"
	@echo ""
	@echo "$(BLUE)Available endpoints:$(RESET)"
	{% if has_health_checks %}
	@echo "- Health: http://localhost:8000/health"
	@echo "- Ready: http://localhost:8000/ready"
	{% endif %}
	@echo "- Info: http://localhost:8000/info"
	{% if has_metrics %}
	@echo "- Metrics: http://localhost:9090/metrics"
	{% endif %}

# Quick commands
quick-test: ## Quick test run
	@. $(ACTIVATE); pytest app/sample-app/ -v

quick-lint: ## Quick lint check
	@. $(ACTIVATE); flake8 app/sample-app/ --max-line-length=127

quick-format: ## Quick format
	@. $(ACTIVATE); black app/sample-app/ --line-length=127

# CI/CD helpers
ci-test: ## Run CI tests
	@echo "$(GREEN)Running CI tests...$(RESET)"
	@make lint
	@make test
	@make security-scan

ci-build: ## Run CI build
	@echo "$(GREEN)Running CI build...$(RESET)"
	@make clean
	@make install
	@make ci-test
	{% if has_docker %}
	@make build
	{% endif %}

# Backup and restore
backup: ## Backup configuration and data
	@echo "$(GREEN)Creating backup...$(RESET)"
	@mkdir -p backups
	@tar -czf backups/backup-$(shell date +%Y%m%d_%H%M%S).tar.gz \
		.env \
		k8s/ \
		containers/ \
		infra/ \
		monitoring/ \
		security/ \
		scripts/ \
		Makefile
	@echo "$(GREEN)Backup created$(RESET)"

list-backups: ## List available backups
	@echo "$(BLUE)Available backups:$(RESET)"
	@ls -la backups/ 2>/dev/null || echo "No backups found"

# Documentation
docs: ## Generate documentation
	@echo "$(GREEN)Generating documentation...$(RESET)"
	@. $(ACTIVATE); pip install sphinx
	@if [ ! -d "docs" ]; then mkdir docs; fi
	@sphinx-quickstart docs --quiet --no-prompt --project="$(PROJECT_NAME)" --author="DevOps Team" --version="1.0"
	@echo "$(GREEN)Documentation generated in docs/$(RESET)"

# Performance
perf-test: ## Run performance tests
	@echo "$(GREEN)Running performance tests...$(RESET)"
	@if command -v ab > /dev/null; then \
		ab -n 1000 -c 10 http://localhost:8000/health; \
	else \
		echo "$(YELLOW)Apache Bench (ab) not found. Install it to run performance tests.$(RESET)"; \
	fi

load-test: ## Run load tests
	@echo "$(GREEN)Running load tests...$(RESET)"
	@if command -v hey > /dev/null; then \
		hey -n 1000 -c 20 http://localhost:8000/health; \
	else \
		echo "$(YELLOW)hey not found. Install it to run load tests.$(RESET)"; \
	fi
