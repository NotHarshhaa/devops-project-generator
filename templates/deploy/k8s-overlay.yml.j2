apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: {{ project_name }}-{{ env }}

bases:
  - ../../base

namespace: {{ project_name }}-{{ env }}

namePrefix: {{ env }}-

commonLabels:
  environment: {{ env }}

replicas:
- name: {{ project_name }}
  count: {% if env == 'production' %}3{% elif env == 'staging' %}2{% else %}1{% endif %}

images:
- name: {{ project_name }}
  newTag: {% if env == 'production' %}latest{% elif env == 'staging' %}staging{% else %}dev{% endif %}

patchesStrategicMerge:
- deployment-patch.yaml
- service-patch.yaml

configMapGenerator:
- name: {{ project_name }}-config
  behavior: merge
  literals:
  - LOG_LEVEL={% if env == 'development' %}DEBUG{% elif env == 'staging' %}INFO{% else %}WARNING{% endif %}
  - ENV={{ env }}
  - DEBUG={% if env == 'development' %}true{% else %}false{% endif %}

secretGenerator:
- name: {{ project_name }}-secrets
  behavior: merge
  envs:
  - secrets.env

resources:
{% if env == 'production' %}
- ingress.yaml
- hpa.yaml
{% endif %}
{% if env == 'development' %}
- service-account.yaml
{% endif %}

{% if env == 'production' %}
patchesJson6902:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: {{ project_name }}
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/resources/limits
      value:
        memory: "1Gi"
        cpu: "1000m"
    - op: add
      path: /spec/template/spec/containers/0/resources/requests
      value:
        memory: "512Mi"
        cpu: "500m"
{% endif %}

vars:
- name: PROJECT_NAME
  objref:
    kind: ConfigMap
    name: {{ project_name }}-config
  fieldref:
    fieldpath: data.PROJECT_NAME
