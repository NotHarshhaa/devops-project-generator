#!/bin/bash

# VM Deployment Script for {{ project_name }}
# Environment: {{ env | default('production') }}

set -euo pipefail

# Configuration
PROJECT_NAME="{{ project_name }}"
ENVIRONMENT="{{ env | default('production') }}"
APP_DIR="/opt/${PROJECT_NAME}"
SERVICE_USER="${PROJECT_NAME}"
REPO_URL="https://github.com/NotHarshhaa/${PROJECT_NAME}.git"
BRANCH="{% if env == 'development' %}develop{% elif env == 'staging' %}staging{% else %}main{% endif %}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
    exit 1
}

warning() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "This script must be run as root"
    fi
}

# Install system dependencies
install_dependencies() {
    log "Installing system dependencies..."
    
    # Update package index
    apt-get update
    
    # Install required packages
    apt-get install -y \
        python3 \
        python3-pip \
        python3-venv \
        nginx \
        postgresql \
        postgresql-contrib \
        redis-server \
        git \
        curl \
        wget \
        unzip \
        supervisor \
        ufw
    
    # Start and enable services
    systemctl enable postgresql
    systemctl enable redis-server
    systemctl enable nginx
    systemctl enable supervisor
    
    log "Dependencies installed successfully"
}

# Create service user
create_service_user() {
    log "Creating service user: ${SERVICE_USER}"
    
    if ! id "${SERVICE_USER}" &>/dev/null; then
        useradd -r -s /bin/false -d "${APP_DIR}" "${SERVICE_USER}"
        log "Service user created"
    else
        log "Service user already exists"
    fi
}

# Setup application directory
setup_app_directory() {
    log "Setting up application directory: ${APP_DIR}"
    
    # Create directories
    mkdir -p "${APP_DIR}"
    mkdir -p "${APP_DIR}/logs"
    mkdir -p "${APP_DIR}/config"
    mkdir -p "${APP_DIR}/static"
    mkdir -p "${APP_DIR}/media"
    
    # Set permissions
    chown -R "${SERVICE_USER}:${SERVICE_USER}" "${APP_DIR}"
    chmod 755 "${APP_DIR}"
    
    log "Application directory setup completed"
}

# Clone or update application code
deploy_code() {
    log "Deploying application code..."
    
    if [[ -d "${APP_DIR}/.git" ]]; then
        # Update existing repository
        cd "${APP_DIR}"
        sudo -u "${SERVICE_USER}" git fetch origin
        sudo -u "${SERVICE_USER}" git reset --hard "origin/${BRANCH}"
        log "Code updated"
    else
        # Clone fresh repository
        sudo -u "${SERVICE_USER}" git clone "${REPO_URL}" "${APP_DIR}"
        cd "${APP_DIR}"
        sudo -u "${SERVICE_USER}" git checkout "${BRANCH}"
        log "Code cloned"
    fi
}

# Setup Python virtual environment
setup_python_env() {
    log "Setting up Python virtual environment..."
    
    cd "${APP_DIR}"
    
    # Create virtual environment if it doesn't exist
    if [[ ! -d "venv" ]]; then
        sudo -u "${SERVICE_USER}" python3 -m venv venv
        log "Virtual environment created"
    fi
    
    # Install dependencies
    sudo -u "${SERVICE_USER}" ./venv/bin/pip install --upgrade pip
    sudo -u "${SERVICE_USER}" ./venv/bin/pip install -r app/sample-app/requirements.txt
    
    log "Python environment setup completed"
}

# Setup database
setup_database() {
    log "Setting up database..."
    
    # Create database and user
    sudo -u postgres psql -c "CREATE DATABASE ${PROJECT_NAME};" || true
    sudo -u postgres psql -c "CREATE USER ${SERVICE_USER} WITH PASSWORD 'secure_password';" || true
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE ${PROJECT_NAME} TO ${SERVICE_USER};" || true
    
    # Run migrations (if applicable)
    cd "${APP_DIR}"
    sudo -u "${SERVICE_USER}" ./venv/bin/python -c "
import os
os.environ['DATABASE_URL'] = 'postgresql://${SERVICE_USER}:secure_password@localhost/${PROJECT_NAME}'
# Add migration logic here if needed
"
    
    log "Database setup completed"
}

# Create systemd service
create_systemd_service() {
    log "Creating systemd service..."
    
    cat > "/etc/systemd/system/${PROJECT_NAME}.service" << EOF
[Unit]
Description=${PROJECT_NAME} Application
After=network.target postgresql.service redis.service
Wants=postgresql.service redis.service

[Service]
Type=simple
User=${SERVICE_USER}
Group=${SERVICE_USER}
WorkingDirectory=${APP_DIR}
Environment=PATH=${APP_DIR}/venv/bin
Environment=ENV=${ENVIRONMENT}
Environment=DATABASE_URL=postgresql://${SERVICE_USER}:secure_password@localhost/${PROJECT_NAME}
Environment=REDIS_URL=redis://localhost:6379/0
Environment=LOG_LEVEL=info
ExecStart=${APP_DIR}/venv/bin/python app/sample-app/main.py
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable "${PROJECT_NAME}"
    
    log "Systemd service created"
}

# Configure nginx
configure_nginx() {
    log "Configuring nginx..."
    
    cat > "/etc/nginx/sites-available/${PROJECT_NAME}" << EOF
server {
    listen 80;
    server_name {% if env == 'production' %}{{ project_name }}.com{% elif env == 'staging' %}staging.{{ project_name }}.com{% else %}dev.{{ project_name }}.com{% endif %};
    
    access_log /var/log/nginx/${PROJECT_NAME}_access.log;
    error_log /var/log/nginx/${PROJECT_NAME}_error.log;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    {% if has_health_checks %}
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        access_log off;
    }
    {% endif %}
    
    {% if has_metrics %}
    location /metrics {
        proxy_pass http://127.0.0.1:8000/metrics;
        allow 127.0.0.1;
        deny all;
    }
    {% endif %}
    
    location /static/ {
        alias ${APP_DIR}/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF

    # Enable site
    ln -sf "/etc/nginx/sites-available/${PROJECT_NAME}" "/etc/nginx/sites-enabled/"
    rm -f "/etc/nginx/sites-enabled/default"
    
    # Test and reload nginx
    nginx -t && systemctl reload nginx
    
    log "Nginx configured"
}

# Setup firewall
setup_firewall() {
    log "Setting up firewall..."
    
    # Reset UFW
    ufw --force reset
    
    # Default policies
    ufw default deny incoming
    ufw default allow outgoing
    
    # Allow SSH
    ufw allow ssh
    
    # Allow web traffic
    ufw allow 80/tcp
    ufw allow 443/tcp
    
    # Enable firewall
    ufw --force enable
    
    log "Firewall configured"
}

# Setup log rotation
setup_log_rotation() {
    log "Setting up log rotation..."
    
    cat > "/etc/logrotate.d/${PROJECT_NAME}" << EOF
${APP_DIR}/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 ${SERVICE_USER} ${SERVICE_USER}
    postrotate
        systemctl reload ${PROJECT_NAME}
    endscript
}
EOF

    log "Log rotation configured"
}

# Start services
start_services() {
    log "Starting services..."
    
    # Start application
    systemctl start "${PROJECT_NAME}"
    
    # Check service status
    if systemctl is-active --quiet "${PROJECT_NAME}"; then
        log "Application started successfully"
    else
        error "Failed to start application"
    fi
    
    # Show service status
    systemctl status "${PROJECT_NAME}" --no-pager
}

# Health check
health_check() {
    log "Performing health check..."
    
    # Wait for application to start
    sleep 10
    
    # Check if application is responding
    if curl -f "http://localhost:8000/health" > /dev/null 2>&1; then
        log "Health check passed"
    else
        warning "Health check failed - application may still be starting"
    fi
}

# Main deployment function
main() {
    log "Starting deployment of ${PROJECT_NAME} to ${ENVIRONMENT} environment"
    
    check_root
    install_dependencies
    create_service_user
    setup_app_directory
    deploy_code
    setup_python_env
    setup_database
    create_systemd_service
    configure_nginx
    setup_firewall
    setup_log_rotation
    start_services
    health_check
    
    log "Deployment completed successfully!"
    log "Application is running at: http://{% if env == 'production' %}{{ project_name }}.com{% elif env == 'staging' %}staging.{{ project_name }}.com{% else %}dev.{{ project_name }}.com{% endif %}"
}

# Run main function
main "$@"
