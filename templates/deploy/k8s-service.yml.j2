apiVersion: v1
kind: Service
metadata:
  name: {{ project_name }}
  labels:
    app: {{ project_name }}
    service-type: application
  annotations:
    {% if has_metrics %}
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"
    {% endif %}
    {% if security == 'standard' or security == 'strict' %}
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
    service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    {% endif %}
spec:
  type: {% if env == 'production' %}LoadBalancer{% else %}ClusterIP{% endif %}
  ports:
  - name: http
    port: 80
    targetPort: 8000
    protocol: TCP
    {% if env == 'production' %}
  - name: https
    port: 443
    targetPort: 8000
    protocol: TCP
    {% endif %}
  selector:
    app: {{ project_name }}
  {% if security == 'standard' or security == 'strict' %}
  sessionAffinity: None
  {% endif %}

---
{% if env == 'production' %}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ project_name }}-ingress
  labels:
    app: {{ project_name }}
  annotations:
    kubernetes.io/ingress.class: "nginx"
    {% if security == 'standard' or security == 'strict' %}
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    {% endif %}
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
spec:
  {% if security == 'standard' or security == 'strict' %}
  tls:
  - hosts:
    - {{ project_name }}.com
    secretName: {{ project_name }}-tls
  {% endif %}
  rules:
  - host: {{ project_name }}.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ project_name }}
            port:
              number: 80
  {% if env == 'development' %}
  - host: dev.{{ project_name }}.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ project_name }}
            port:
              number: 80
  {% endif %}
{% endif %}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ project_name }}-config
  labels:
    app: {{ project_name }}
data:
  config.yaml: |
    app:
      name: "{{ project_name }}"
      environment: "{{ env | default('production') }}"
      debug: {% if env == 'development' %}true{% else %}false{% endif %}
      port: 8000
    database:
      host: "{{ project_name }}-db"
      port: 5432
      name: "{{ project_name }}"
      pool_size: 10
      max_overflow: 20
    redis:
      host: "{{ project_name }}-redis"
      port: 6379
      db: 0
    logging:
      level: "{% if env == 'development' %}DEBUG{% elif env == 'staging' %}INFO{% else %}WARNING{% endif %}"
      format: "json"
    {% if has_metrics %}
    metrics:
      enabled: true
      port: 9090
      path: "/metrics"
    {% endif %}
    {% if security == 'standard' or security == 'strict' %}
    security:
      cors_origins:
        - "https://{{ project_name }}.com"
        {% if env == 'development' %}
        - "http://localhost:3000"
        {% endif %}
      rate_limit:
        requests_per_minute: 100
      session_timeout: 3600
    {% endif %}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ project_name }}-secrets
  labels:
    app: {{ project_name }}
type: Opaque
data:
  # Base64 encoded values
  database-url: cG9zdGdyZXNxbDovL3Bvc3RncmVzOnBhc3N3b3JkQHt7IHByb2plY3RfbmFtZSB9fS1kYjo1NDMyL3t7IHByb2plY3RfbmFtZSB9fQ==
  jwt-secret: eW91ci1qd3Qtc2VjcmV0LWhlcmU=
  api-key: eW91ci1hcGkta2V5LWhlcmU=
